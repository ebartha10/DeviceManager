http:
  routers:

    # OPTIONS requests for CORS preflight
    device-api-options:
      rule: "Host(`localhost`) && PathPrefix(`/device`) && Method(`OPTIONS`)"
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers
      service: device-service
      priority: 10

    user-api-options:
      rule: "Host(`localhost`) && PathPrefix(`/users`) && Method(`OPTIONS`)"
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers
      service: user-service
      priority: 10

    device-api:
      rule: "Host(`localhost`) && PathPrefix(`/device`)" # Match requests to localhost with /device prefix
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers # Add CORS headers
        - auth-forward # Validate JWT via auth service and forward headers
      service: device-service

    user-api:
      rule: "Host(`localhost`) && PathPrefix(`/users`)" # Match requests to localhost with /users prefix
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers # Add CORS headers
        - auth-forward # Validate JWT via auth service and forward headers
      service: user-service

    user-api-internal:
      rule: "Host(`user-microservice`) && PathPrefix(`/users`)" # Internal service-to-service calls
      entryPoints:
        - web
      middlewares:
        - strip-user-prefix # Remove /users prefix before forwarding
      service: user-service

    device-api-internal:
      rule: "Host(`device-microservice`) && PathPrefix(`/users`)" # Internal service-to-service calls for device service
      entryPoints:
        - web
      middlewares:
        - strip-device-user-prefix # Remove /users prefix for internal device calls
      service: device-service

    auth-api:
      rule: "Host(`localhost`) && PathPrefix(`/api/auth`) && !PathPrefix(`/api-docs`)" # Match requests to localhost with /api/auth prefix
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers # Add CORS headers
      service: auth-service

    api-docs-yaml:
      rule: "Host(`localhost`) && Path(`/api-docs/openapi.yaml`)" # Specific route for YAML file
      entryPoints:
        - websecure
      tls: {}
      # Don't strip prefix - Swagger UI needs to serve at /api-docs
      service: api-docs-service
      priority: 5

    api-docs:
      rule: "Host(`localhost`) && PathPrefix(`/api-docs`)" # Match requests to localhost with /api-docs prefix
      entryPoints:
        - websecure
      tls: {}
      # Don't strip prefix - Swagger UI needs to serve at /api-docs
      service: api-docs-service

    # OPTIONS requests for CORS preflight
    monitoring-api-options:
      rule: "Host(`localhost`) && PathPrefix(`/monitoring`) && Method(`OPTIONS`)"
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers
      service: monitoring-service
      priority: 10

    # WebSocket endpoint - bypass auth-forward as WebSocket connections handle auth differently
    # This must come BEFORE the general monitoring-api route to match first
    monitoring-websocket:
      rule: "Host(`localhost`) && PathPrefix(`/monitoring/ws`)" # Match WebSocket connections and SockJS /info endpoint
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers # Add CORS headers
        - strip-monitoring-prefix # Remove /monitoring prefix before forwarding
      service: monitoring-swarm-service
      priority: 20

    monitoring-api:
      rule: "Host(`localhost`) && PathPrefix(`/monitoring`) && !PathPrefix(`/monitoring/ws`)" # Match requests to localhost with /monitoring prefix, but NOT /monitoring/ws
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers # Add CORS headers
        - auth-forward # Validate JWT via auth service and forward headers
        - strip-monitoring-prefix # Remove /monitoring prefix before forwarding
      service: monitoring-service

    # OPTIONS requests for CORS preflight - Chat API
    chat-api-options:
      rule: "Host(`localhost`) && PathPrefix(`/chat`) && Method(`OPTIONS`)"
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers
      service: chat-service
      priority: 10

    # WebSocket endpoint for chat - bypass auth-forward as WebSocket connections handle auth differently
    # This must come BEFORE the general chat-api route to match first
    chat-websocket:
      rule: "Host(`localhost`) && PathPrefix(`/ws/chat`)" # Match WebSocket connections and SockJS /info endpoint
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers # Add CORS headers
      service: websocket-service
      priority: 20

    # Chat REST API endpoint
    chat-api:
      rule: "Host(`localhost`) && PathPrefix(`/chat`) && !PathPrefix(`/ws/chat`)" # Match requests to localhost with /chat prefix, but NOT /ws/chat
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - cors-headers # Add CORS headers
        - auth-forward # Validate JWT via auth service and forward headers
      service: chat-service

    # Frontend Router
    frontend:
      rule: "Host(`localhost`)" 
      entryPoints:
        - websecure
      tls: {}
      service: frontend-service
      priority: 1 # Lowest priority, fallback for everything else

  middlewares:
    strip-device-prefix: # Middleware to remove /device prefix
      stripPrefix: 
        prefixes:
          - "/device"

    strip-user-prefix: # Middleware to remove /users prefix
      stripPrefix: 
        prefixes:
          - "/users"

    strip-device-user-prefix: # Middleware to remove /users prefix for device service internal calls
      stripPrefix:
        prefixes:
          - "/users"

    strip-auth-prefix: # Middleware to remove /api/auth prefix
      stripPrefix:
        prefixes:
          - "/api/auth"

    strip-api-docs-prefix: # Middleware to remove /api-docs prefix
      stripPrefix:
        prefixes:
          - "/api-docs"

    strip-monitoring-prefix: # Middleware to remove /monitoring prefix
      stripPrefix:
        prefixes:
          - "/monitoring"
    
    strip-monitoring-ws-prefix: # Middleware to remove /monitoring prefix but keep /ws
      stripPrefix:
        prefixes:
          - "/monitoring"

    auth-forward: # Middleware to validate JWT via auth service and forward headers
      forwardAuth:
        address: "http://auth-microservice:8080/api/auth/validate"
        authRequestHeaders:
          - "Authorization"
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Role"

    auth-basic: # Middleware for basic authentication
      basicAuth:
        users:
          - "user:$apr1$H6uskkkW$IgXLP6ewTrSuBkTrqE8wj/" # password = "test"

    cors-headers: # Middleware to add CORS headers
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowOriginList:
          - "http://localhost:5173"
          - "http://localhost:3000"
          - "http://localhost"
          - "https://localhost"
          - "https://localhost:5173"
          - "https://localhost:3000"
        accessControlAllowHeaders:
          - "*"
        accessControlAllowCredentials: true
        accessControlMaxAge: 3600
        addVaryHeader: true


  services:
    device-service:
      loadBalancer:
        servers:
          - url: "http://device-microservice:8080" # Device microservice container

    user-service:
      loadBalancer:
        servers:
          - url: "http://user-microservice:8080" # User microservice container

    auth-service:
      loadBalancer:
        servers:
          - url: "http://auth-microservice:8080" # Auth microservice container

    api-docs-service:
      loadBalancer:
        servers:
          - url: "http://api-docs:8080" # API documentation service

    monitoring-service:
      loadBalancer:
        servers:
          - url: "http://load-balancer:8080" # Custom Java Load Balancer

    monitoring-swarm-service:
      loadBalancer:
        servers:
          - url: "http://monitoring-microservice:8080" # Direct access to monitoring microservice (for WebSockets)

    chat-service:
      loadBalancer:
        servers:
          - url: "http://chat-microservice:8080" # Chat microservice container

    websocket-service:
      loadBalancer:
        servers:
          - url: "http://websocket-microservice:8080" # WebSocket microservice container

    frontend-service:
      loadBalancer:
        servers:
          - url: "http://demo_stack_frontend:3000" # Frontend container (swarm service name)
